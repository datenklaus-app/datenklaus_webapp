{% extends "base.html" %}

{# Load static files#}
{% load static %}
{# Translations #}
{% load i18n %}

{# Load custom css (overwrites base.css) #}
{% block css %}
    <link rel="stylesheet" href="{% static '/teacher/style.css' %}">
{% endblock %}

{# Translations #}
{% load i18n %}

{# Set page Title #}
{% block title %}DK ☰ {{ room_name }}{% endblock %}

{% block content %}
    <!-- Strings -->
    {% trans "Raum wählen" as no_room_selected %}
    {# Teacher navbar #}
    <nav class="navbar navbar-expand navbar-dark bg-dark">
        <span class="navbar-brand mb-0 h1">Datenklaus</span>

        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav mr-auto">
                {% if room_name is not None %}
                    <li class="nav-item">
                        <a class="nav-link {% if is_overview %}active{% endif %}" id="button-overview"
                           href="{% url "overview" %}">Übersicht <span
                                class="sr-only">(current)</span></a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link {% if is_results %}active{% endif %}" id="button-auswertung"
                           href="{% url "results" room_name %}">Auswertung</a>
                    </li>
                {% endif %}
            </ul>
            <div class="dropdown">
                <button class="btn btn-light dropdown-toggle text-dark" type="button" id="dropdownMenuButton"
                        data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    {% if room_name %} {{ room_name }} {% else %} {{ no_room_selected }} {% endif %}
                </button>
                <div class="dropdown-menu dropdown-menu-right" id="dropDownRooms" aria-labelledby="dropdownMenuButton">
                    <a class="dropdown-item" type="button" href="{% url 'create' %}" id="createNewRoom">
                        Neuen Raum erstellen
                    </a>
                    <div id="dropdownDivider" class="dropdown-divider"></div>
                </div>
            </div>
        </div>
    </nav>

    {% if room_name %}
        <div class="container-fluid">
            <div class="row justify-content-center pt-2 pb-2 bg-light">
                <div class="col text-dark align-self-center">
                    <h4 class="m-0 text-secondary"> Modul: <span id="roomLesson" class="text-dark">{{ lesson }}</span>
                    </h4>
                </div>
                <div class="col text-right m-1">
                    <button class="btn state-btn-play" id="button-play">
                        <i class="fas fa-play"></i>
                    </button>
                    <button class="btn state-btn-pause" id="button-pause">
                        <i class="fas fa-pause"></i>
                    </button>
                    <button class="btn state-btn-stop" id="button-stop">
                        <i class="fas fa-stop"></i>
                    </button>
                    <a tabindex="0" class="btn btn-sm text-secondary" style="cursor: pointer"
                       role="button" id="control-popover" title="Steuerung" data-trigger="hover">
                        <i class="fas fa-question"></i>
                    </a>
                </div>
            </div>
        </div>
    {% endif %}

    {% block teacher_content %}
    {% endblock %}
{% endblock %}

{% block scripts %}
    <script>
        const cmds = {
            PLAY: 0,
            PAUSE: 1,
            STOP: 2,
        };

        const states = {
            CLOSED: 0,
            WAITING: 1,
            RUNNING: 2,
            PAUSED: 3,
        };

        let state = {{ state }};

        $(document).ready(function () {
            $("#button-play").click(function () {
                controlCommand($(this), cmds.PLAY, states.RUNNING)
            });
            $("#button-pause").click(function () {
                controlCommand($(this), cmds.PAUSE, states.PAUSED)
            });
            $("#button-stop").click(function () {
                controlCommand($(this), cmds.STOP, states.CLOSED)
            });

            $('.popover-dismiss').popover({
                trigger: 'focus'
            });

            $('#control-popover').popover({
                html: true,
                content: function () {
                    const template = Handlebars.compile($("#popover-template").html());
                    return (template())
                },
            });

            setStates();
            getRooms();
            setInterval(getRooms, 2000);
        });

        setStates = function () {
            $('#button-play').prop('disabled', state === states.RUNNING);
            $('#button-pause').prop('disabled', state === states.PAUSED);
            $('#button-stop').prop('disabled', state === states.CLOSED);
        };

        controlCommand = function (el, cmd, s) {
            el.blur();
            $.ajax({
                url: "/teacher/control",
                data: {'room_name': "{{ room_name }}", 'cmd': cmd},
                dataType: 'json',
                success: function () {
                    state = s;
                    setStates()
                },
                error: function (jqXHR) {
                    // TODO: remove?
                    console.log(jqXHR.responseJSON.err)
                }
            })
        };

        getRooms = function () {
            $.ajax({
                url: "{% url "rooms" %}",
                dataType: 'json',
                success: function (data) {
                    const list = $("#dropDownRooms");
                    const l = $('.dropdown-item[data-delete="true"]');
                    // Empty dropdown menu except static entries
                    $.each(l, function (i, v) {
                        v.remove();
                    });
                    /** @namespace data.rooms **/
                    $.each(data.rooms, function (index, room_name) {
                        list.append($('<button class="dropdown-item" data-delete="true"></button>').text(room_name).click(function () {
                            $('#dropdownMenuButton').text(room_name);
                            window.location.href = "{% url "overview" %}" + room_name
                        }));
                    })
                }
            })
        };

        createTestStudents = function () {
            $.ajax({
                url: "/teacher/test-students",
                data: {
                    'room_name': "{{room_name}}"
                },
                dataType: 'json',
                success: function () {
                    console.log("Test students created")
                },
                error: function (data) {
                    // TODO: remove?
                    console.log(data.error)
                }
            })
        };
    </script>
    <script src="{% static "teacher/js/room.js" %}"></script>
    {% block teacher-content-scripts %}
    {% endblock %}
    {% block teacher-room-control-scripts %}
    {% endblock %}
{% endblock %}
